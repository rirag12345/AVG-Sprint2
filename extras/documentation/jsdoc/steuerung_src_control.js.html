<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: steuerung/src/control.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: steuerung/src/control.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Control module for managing smart devices in a home.
 * Managing heating in rooms by commanding thermostats based on temperature values from temperature sensors.
 * Using treshold to decide if heating should turned up or down.
 * Also creates a log file for temperature values.
 * Using integration technique message exchange via MQTT.
 * Control acts as consumer and producer for messages.
 * @module control
 * @requires CLIENT
 * @exports start
 * @author Felix Jaeger
 */
import { CLIENT } from "./main.js";
import fs from "node:fs";

/**
 * Handles incoming messages from all temperature sensors.
 * Checks if temperature is below or above teshhold.
 * Sends commands to thermostats to turn up or turn down heating.
 * Logs the temperature values into the log file.
 * @returns {void}
 */
function messageHandler() {
    CLIENT.on("message", (_, receivedMessage) => {

        // extracting room and temperature from received message.
        const room = receivedMessage.toString().split(":")[0];
        const temperature = receivedMessage.toString().split(":")[1];

        // determine current date with time to include in log file. comes in UTC time zone.
        const DateTime = new Date();

        // converting dateTime to ISO string.
        const timestamp = DateTime.toISOString();

        // log temperature into log file.
        fs.appendFile("./log/control.log", `${timestamp}: temperature in room ${room}: ${temperature}째C\n`, () => {});

        // check if temperature is too low. if yes, turn up heating.
        if (temperature &lt; 19) {
            // eslint-disable-next-line no-console -- message to console
            console.info(`room ${room} is too cold (&lt;19째C). turning up heating.`);
            CLIENT.publish("thermostat", `${room}:23`);
        }

        // check if temperature is high enough. if yes, turn down heating.
        if (temperature >= 23) {
            // eslint-disable-next-line no-console -- message to console
            console.info(`room ${room} is warm enough (>=23째C). turning down heating.`);
            CLIENT.publish("thermostat", `${room}:19`);
        }
    });
}

/**
 * Starts the control.
 * @returns {void}
 */
export function start() {
    // eslint-disable-next-line no-console -- message to console
    console.info("control started.");

    // create log file.
    fs.writeFile("./log/control.log", "-------------------- temperature log file --------------------\n", () => {});

    // subscribe to temperature sensors topic to receive temperature values from all sensors.
    CLIENT.subscribe("temperatursensor");
    messageHandler();
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-control.html">control</a></li><li><a href="module-main.html">main</a></li><li><a href="module-sensor.html">sensor</a></li><li><a href="module-thermostat.html">thermostat</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Thu Nov 07 2024 08:47:57 GMT+0100 (Mitteleurop채ische Normalzeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
